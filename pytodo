#!/usr/bin/env python3
import argparse
from _datetime import datetime, timedelta
import sqlite3
import os

CREATE_TABLE_QUERY = (
        'CREATE TABLE IF NOT EXISTS all_notes '
        '(id integer primary key autoincrement,name text, note text, started date, deadline date)'
)

DATABASE_NAME = "tasks.db"

DATABASE_PATH = os.path.join(
    os.path.dirname(os.path.abspath(__file__)),
    DATABASE_NAME
)


def check_db():
    if os.path.exists(DATABASE_PATH):
        print("Tasks database already exists. Aborting initialization.")
        return

    print("No tasks database found. Initializing new database at path {}.".format(DATABASE_PATH))

    con = sqlite3.connect(DATABASE_PATH)

    cursor = con.cursor()

    cursor.execute(CREATE_TABLE_QUERY)


def create_task(args):
    print("Create new task:")

    new_note = input("Enter new note: ")
    note_name = input("Choose title for this note: ")

    end_time = datetime.strptime(input("Enter deadline date YY/MM/DD: "), '%Y/%m/%d')

    con = sqlite3.connect(DATABASE_PATH)

    cursor = con.cursor()

    cursor.execute(
        "INSERT INTO all_notes (name, note, started, deadline) VALUES (?,?,?,?)",
        (note_name, new_note, datetime.now(), end_time)
    )

    con.commit()
    cursor.close()
    con.close()

    print("You could watch your note by 'list'")


def delete_task(args):

    con = sqlite3.connect(DATABASE_PATH)

    cursor = con.cursor()

    cursor.execute("DELETE FROM all_notes WHERE id = ?", (args.id, ))

    con.commit()
    cursor.close()
    con.close()
    print("Your updated journal is available by 'list'")


def list_tasks(args):
    print("All tasks")

    con = sqlite3.connect(DATABASE_PATH)

    cursor = con.cursor()

    cursor.execute("SELECT * FROM all_notes")

    rows = cursor.fetchall()

    columns = [description[0] for description in cursor.description]

    cursor.close()
    con.close()

    print('\033[47m''\033[31m' + "| {:2} | {:16} | {:55} | {:30} | {:<30}".format(columns[0], columns[1], columns[2], columns[3],
                                                                       columns[4]).upper() + '\033[00m''\033[00m')

    for row in rows:
        print("| {:2} | {:<16} | {:<55} | {:30} | {:<30}".format(row[0], row[1], row[2], row[3], row[4]))


if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    subparsers = parser.add_subparsers()

    delete_parser = subparsers.add_parser('delete')
    list_parser = subparsers.add_parser('list')
    new_parser = subparsers.add_parser('new')

    delete_parser.add_argument('id', type=int)

    delete_parser.set_defaults(func=delete_task)
    list_parser.set_defaults(func=list_tasks)
    new_parser.set_defaults(func=create_task)

    parsed_args = parser.parse_args()

    check_db()

    parsed_args.func(parsed_args)


